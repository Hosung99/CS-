# Chapter8 입출력장치

## 8-1) 장치 컨트롤러와 장치 드라이버

**장치 컨트롤러** 와 **장치 드라이버**라는 개념을 통해 다양한 외부 장치가 컴퓨터 내부에서 어떻게 연결하고 소통하는지 알아본다.

### 장치 컨트롤러

1. 입출력장치에는 종류가 너무나도 많아, 정보의 규격화가 어렵다.
2. 일반적으로 CPU와 메모리의 데이터 전송률은 높지만 입출력장치의 데이터 전송률은 낮다.

따라서 입출력 장치는 컴퓨터에 직접 연결되지 않고 **장치 컨트롤러**라는 하드웨어를 통해 연결된다. 장치 컨트롤러는 **입출력 제어기**, **입출력 모듈**등으로 불리기도 한다.

장치 컨트롤러는 다음과 같은 역할들을 한다.

- CPU와 입출력장치 간의 통신 중개
- 오류 검출
- 데이터 버퍼링

이 중 세번째, **버퍼링**이란 전송률이 높은 장치와 낮은 장치 사이에 주고받는 데이터를 **버퍼**라는 임시 저장 공간에 저장하여 전송률을 비슷하게 맞추는 방법이다.

장치컨트롤러의 내부 구조는 다음과 같다.

- **데이터 레지스터**
- **상태 레지스터**
- **제어 레지스터**

**데이터 레지스터**는 CPU와 입출력장치 사이에 주고받을 데이터가 담기는 레지스터이다. 데이터 레지스터가 버퍼역할을 한다.

**상태 레지스터**는 입출력 장치가 입출력 작업을 할 준비가 되었는지, 완료되었는지, 오류는 없는지 등의 상태정보를 저장한다.

**제어 레지스터**는 입출력장치가 수행할 내용에 대한 제어 정보와 명령을 저장한다.

### 장치 드라이버

새로운 장치를 컴퓨터에 연결하려면 장치 드라이버를 설치해야 한다. **장치 드라이버**란 장치 컨트롤러의 동작을 감지하고 제어함으로써 장치 컨트롤러가 컴퓨터 내부와 정보를 주고받을 수 있게 하는 프로그램이다.

## 8-2) 다양한 입출력 방법

장치컨트롤러는 크게 3가지 방법으로 CPU와 정보를 주고 받는다.

1. **프로그램 입출력**
2. **인터럽트 기반 입출력**
3. **DMA 입출력**

### 프로그램 입출력

**프로그램 입출력**은 프로그램 속 명령어로 입출력장치를 제어하는 방법이다. CPU가 프로그램 속 명령어를 실행하는 과정에서 입출력 명령어를 만나면 CPU는 입출력장치에 연결된 장치 컨트롤러와 상호작용하며 입출력 작업을 수행한다.

ex) CPU의 입출력 작업과정

1. '메모리에 저장된 정보를 하드 디스크에 백업한다'는 말은 '하드디스크에 새로운 정보를 쓴다'는 말과 같다. 우선 CPU는 하드 디스크 컨트롤러의 제어 레지스터에 쓰기 명령을 보낸다.

2. 하드 디스크 컨트롤러는 하드 디스크 상태를 확인한다. 하드 디스크가 준비된 상태라면 하드 디스크 컨트롤러는 상태 레지스터에 준비되었다고 표시한다.

3. CPU는 상태 레지스터를 주기적으로 읽어보며 하드 디스크의 준비 여부를 확인한다. 하드 디스크가 준비됐음을 CPU가 알게 되면 백업할 메모리의 정보를 데이터 레지스터에 쓴다. 아직 백업작업이 안 끝났다면 1번을 반복하고, 쓰기가 끝났다면 작업을 종료한다.

이렇든 프로그램 입출력 방식에서 입출력 작업은 CPU가 장치 컨트롤러의 레지스터 값을 읽고 씀으로써 이루어진다. CPU는 어떻게 여러 장치 컨트롤러 속 레지스터들을 모두 알고 있을까? 크게 두가지 방법이 있다.

### 메모리 맵 입출력

**매모리 맵 입출력**은 메모리에 접근하기 위한 주소 공간과 입출력장치에 접근하기 위한 주소 공간을 하나의 주소 공간으로 간주하는 방법이다. 만약 1024개의 주소를 표현할 수 있는 컴퓨터가 있을 때 1024개 전부 메모리 주소를 표현하는데 사용하지 않는다. 512개는 메모리 주소를, 512개는 장치 컨트롤러의 레지스터를 표현하기 위해 사용하는 것이다.

### 고립형 입출력

**고립형 입출력**은 메모리를 위한 주소 공간과 입출력장치를 위한 주소 공간을 분리하는 방법이다. 입출력장치에 접근하기 위해 메모리에 접근하는 명령어와는 다른 입출력 명령어를 사용한다.

### 인터럽트 기반 입출력

입출력장치에 의한 하드웨어 인터럽트는 장치 컨트롤러에 의해 발생한다. CPU는 장치 컨트롤러에 입출력 작업을 명령하고, 장치 컨트롤러가 입출력장치를 제어하며 입출력을 수행하는 동안 CPU는 다른 작업을 수행한다. 장치 컨트롤러가 입출력 작업을 끝낸 뒤 CPU에게 인터럽트 요청 신호를 보내면 CPU는 하던 일을 잠시 백업하고 인터럽트 서비스 루틴을 실행한다. 이를 **인터럽트 기반 입출력**이라고 한다.

인터럽트는 발생한 순서대로 처리할 수도 있지만, 현실적으로 모든 인터럽트를 순서대로 처리하는 것은 불가능하다. 따라서 우선순위를 정해서 처리한다. 플래그 레지스터 속 인터럽트 비트가 활성화되어 있는 경우, 혹은 인터럽트 비트를 비활성화해도 무시할 수 없는 인터럽트인 **NMI (Non-Maskable Interrupt)**가 발생한 경우에는 CPU는 인터럽트를 처리한다.

우선순위를 반영하여 다중 인터럽트를 처리하는 방법 중 제일 많이 사용되는 방법은 **프로그래머블 인터럽트 컨트롤러(PIC)**이다. PIC는 여러 장치 컨트롤러에 연결되어 장치 컨트롤러에서 보낸 하드웨어 인터럽트 요청들의 우선순위를 판별한 뒤 CPU에 지금 처리해야 할 하드웨어 인터럽트는 무엇인지를 알려주는 장치이다.

### DMA 입출력

프로그램 기반 입출력과 인터럽트 기반 입출력의 공통점이 있다면, 입출력장치와 메모리간의 데이터 이동은 CPU가 주도하고, 이동하는 데이터도 반드시 CPU를 거친다는 점이다. 이러한 방식은 CPU에 부담이 커지게 된다. 그래서 입출력장치와 메모리가 CPU를 거치지 않고도 상호작용할 수 있는 **DMA(Direct Memory Access)** 방식이 등장했다. DMA는 이름 그대로 직접 메모리에 접근할 수 있는 입출력 기능이다. DMA 입출력을 하기 위해서는 시스템 버스에 연결된 **DMA 컨트롤러**가 필요하다.

ex) DMA 입출력 과정

1. CPU는 DMA 컨트롤러에게 입출력장치와 메모리 사이의 데이터 전송을 요청한다.

2. DMA 컨트롤러는 CPU대신 장치 컨트롤러와 상호작용하며 입출력 작업을 수행한다. 이때 DMA 컨트롤러는 필요한 경우 메모리에 직접 접근하여 정보를 읽거나 쓴다.

3. 입출력 작업이 끝나면 DMA 컨트롤러는 CPU에 인터럽트를 걸어 작업이 끝났음을 알린다.

### 입출력 버스

DMA 컨트롤러를 이용할 경우 메모리에서 DMA 컨트롤러로 데이터를 가져오기 위해 시스템 버스를 한 번 사용하고, DMA 컨트롤러의 데이터를 장치 컨트롤러로 옮기기 위해 시스템 버스를 또 한 번 사용한다. 이러한 방식은 시스템 버스의 효율을 떨어뜨린다. 이를 해결하기 위해 **입출력 버스**가 등장했다. 대부분의 입출력장치는 시스템 버스가 아닌 입출력 버스와 연결된다. 입출력 버스에는 **PCI (Peripheral Component Interconnect)**버스, **PCI Express(PCIe)**버스 등 여러 종류가 있다.