# 메모리와 캐시 메모리
여기서의 메모리는 RAM을 뜻합니다!

## RAM의 특징와 종류
RAM은 실행할 프로그램의 명령어와 데이터가 저장된다. \
중요한 점은 컴퓨터 전원을 끄면 다 날아간다는 점...!!  이렇게 저장된 내용이 사라지는 저장 장치를 **휘발성 저장 장치**라고 한다.

반명, 전원이 꺼져도 저장된 내용이 유지되는 저장 장치는 비휘발성 저장 장치라고 한다. \
하드 디스크나 SSD, CD-ROM, USB 같은 보조기억 장치가 대표적인 비휘발성 저장 장치이다. \
보조장치는 휘발되지 않지만 CPU의 직접 접근이 불가능 합니다. 따라서 일반적으로 비휘발성 저장 장치에는 '보관할 대상'을 저장하고, 휘발성 저장장치인 RAM에는 '실행할 대상'을 저장한다. CPU가 실행하고 싶은 프로그램이 보조기억장치에 있다면 이를 RAM으로 복사하여 저장한 뒤 실행한다.

### RAM의 용량과 성능
CPU가 실행하고 싶은 프로그램이 보조기억 장치에 있다면 이를 RAM으로 가져와야 할텐데, RAM용량이 적다면 보조기억장치에서 실행할 프로그램을 가져오는 일이 잦아 실행시간이 길어진다. \
이처럼 RAM용량이 크면 많은 프로그램을 동시에 빠르게 실행하는 데에 유리하다. 

### RAM의 종류

#### DRAM
DRAM은 dynamic RAM의 준말로 저장된 데이터가 동적으로 변하는 RAM을 의미한다. 즉, DRAM은 시간이 지나면 저장된 데이터가 점차 사라지는 RAM이다. 그렇기에 DRAM은 데이터의 소멸을 막기위해 일정 주기로 데이터를 다시 저장해야한다.

이런 단점에도 불고하고 우리가 일반적으로 메모리로써 사용하는 RAM은 DRAM이다. 소비 전력이 비교적 낮고, 저렴하고, 집적도가 높기 때문에 대용량으로 설계하히가 용이하기 때문이다. 

#### SRAM
Sram은 static RAM의 준말로 시간이 지나도 저장된 데이터가 사라지지 않는다. 당연하게 주기적으로 데이터를 재활성화 할 필요도 없다. 속도또한 SRAM이 DRAM보다 빠르다.

하지만 낮은 집적도, 큰 소비전력, 비싼 가격 때문에 DRAM이 주로 메모리로 사용된다.
그래서 SRAM은 용량이 클 필요가 없는 캐시메모리에 주로 사용된다.

#### SDRAM
```
SDRAM != SRAM + DRAM;
```
SDRAM은 Synchoronous dynamic RAM으로 클럭 신호와 동기화된, 발전된 형태의 DRAM이다.\
**클럭 신호와 동기화되었다**라는 말은 클럭 타이밍에 맞춰 CPU와 정보를 주고받을 수 있음을 의미. 

#### DDR SDRAM
Double data Rate SDRAM은 최근 가장 흔히 사용되는 RAM이다. 대역폭을 넓혀 속도를 빠르게 만든 SDRAM으로 여기서 **대역폭**은 데이터를 주고받는 길의 너비를 의미한다.

DDR2는 네배, DDR3는 8배 ... 우리가 컴터 살때 자주보죠? 숫자큰게 더 빠르다~

## 메모리의 주소 공간
메모리에 저장된 정보의 위치는 주소로 나타낼 수 있다정도로 정리되었지만 사실 주소는 물리주소와 논리 주소 두 가지 종류가 있습니다. **물리 주소**는 메모리 하드웨어가 사용하는 주소이고, **논리 주소**는 CPU와 실행중인 프로그램이 사용하는 주소이다. 

### 물리주소와 논리주소
물리 주소는 말 그래도 정보가 실제로 저장된 하드웨어상의 주소를 의미한다. 반면 CPU와 실행 중인 프로그램이 사용하는 논리 주소는 실행중인 프로그램 각각에게 부여된 0번지 부터 시작되는 주소를 의미한다.

그런데 CPU가 이해하는 주소가 논리 주소라고는 해도 CPU가 메모리와 상호작용하려면 논리 주소와 물리주소 간의 변환이 이루어져야 할것이다. 논리 주소와 물리 주소 간에 어떠한 변환도 이루어지지 않는다면 CPU와 메모리는 서로 이해할 수 없는 주소 체계를 가지고 각자 다른 이야기만 할 뿐 결코 상호작용할 수 없을 것이다.

그래서 여기서 필요한 것이 **메모리 관리 장치** MMU !!
MMU는 CPU와 주소 버스 사이에 위치한다.

MMU는 CPU가 발생시킨 논리 주소에 베이스 레지스터 값을 더하여 논리 주소를 물리 주소로 변환한다. 현재 베이스 레지스터에 15000이 저장되어 있고, CPU가 발생시킨 논리 주소가 100번지라면 이 논리 주소는 15100번지로 변환이 가능하다.

### 메모리 보호 기법
다른 프로그램의 영역을 침범할 수 있는 명령어는 위험을 야기한다. 따라서 논리 주소 범위를 벗어나는 명령어 실행을 방지하고 실행 중인 프로그램이 다른 프로그램에 영향을 받지 않도록 보호할 방법이 필요하다. 이는 **한계 레지스터**라는 레지스터가 담당한다.

베이스 레지스터가 실행중인 프로그램의 가장 작은 물리 주소를 저장한다면, 한계레지스터는 논리 주소의 최대 크기를 저장한다. 즉, 프로그램의 물리 주소 범위는 베이스 레지스터 값 이상, 베이스 레지스터 값 + 한계 레지스터 값 미만이 된다.

만약 CPU가 한계 레지스터보다 높은 논리 주소에 접근하려고 하면 인터럽트를 발생시켜 실행을 중단한다.

## 캐시메모리
CPU는 프로그램을 실행하는 과정에서 메모리에 저장된 데이터를 빈번하게 사용한다. 하지만 CPU가 메모리에 접근하는 시간이 느리면 CPU의 빠른 연산 속도가 아무런 의미가 없을 것이다. 이를 위해 **캐시메모리**가 생기게 되었다.

### 저장 장치 계층 구조

```mermaid
    graph LR;
    A[레지스터] --> B[메모리]
    B[메모리] --> C[보조기억장치]
```
### 캐시메모리
CPU가 메모리에 접근하는 속도는 레지스터에 접근하는 속도보다 느리다. 그럼에도 CPU는 프로그램을 실행하는 과정에서 메모리에 빈번히 접근해야만 한다.

캐시메모리는 CPU와 메모리 사이에 위치하고, 레지스터보다 용량이 크고 메모리 보다 빠른 SRAM기반의 저장 장치이다.\
CPU의 연산 속도와 메모리 접근 속도의 접근 속도의 차이를 조금이나마 줄이기 위해 탄생했다.

```mermaid
    graph LR;
    A[레지스터] --> D[캐시 메모리]
    D --> B[메모리]
    B[메모리] --> C[보조기억장치]
```

우리가 사용하는 컴퓨터 내부에는 여러 개의 캐시 메모리가 있다. 이 캐시 메모리들은 CPU와 가까운 순서대로 계층을 구성한다. 코어와 가장 가까운 캐시 메모리를 L1, 그 다음 L2, 그 다음을 L3라고 한다.

일반적으로 L1, L2는 CPU 코어 내부에 L3는 코어 외부에 존재한다.

#### 분리형 캐시
코어와 가장 가까운 L1 캐시는 조금이라도 접근 속도를 빠르게 만들기 위해 명령어 만을 저장하는 L1 캐시인 L1l 캐시와 데이터 만을 저장하는 L1D 캐시로 분리하는 경우도 있다.

### 참조 지역성 원리
캐시 메모리는 메모리보다 용량이 작다. 당연하게도 캐시 메모리는 메모리에 있는 모든 내용을 가져다 저장할 수는 없다. 메모리가 보조기억장치의 일부를 복사하여 저장하는 것 처럼 캐시 메모리는 메모리의 일부를 복사하여 저장한다. 그럼 캐시 메모리는 무엇을 저장하나??

캐시 메모리는 CPU가 사용할 법한 대상을 예측하여 저장한다. 이때 자주 사용될 것으로 에측한 데이터가 실제로 들어맞아 캐시 메모리 내 데이터가 CPU에서 활용될 경우를 **캐시히트**라고 한다.
반대로 저장했는데 예측이 틀려 직접 CPU가 메모리에 가지러 가는 것을 **캐시 미스**라고 한다.
캐시 미스가 자주 발생하면 성능이 떨어지겠죠.

캐시가 히트되는 비율을 **캐시 적중률**이라고한다.
```
Cache hit rate = Cache hit count / (Cache hit count + Cache miss count)
```
우리가 보통 사용하는 CPU는 85 ~ 95% 이상이다.

그럼 자주 사용할 법한 데이터를 어떻게 예측할 수 있을까???\
캐시 메모리는 한 가지의 원칙에 따라 메모리로부터 가져올 데이터를 결정한다. **참조 지역성의 원리** 이다. 
1. CPU는 최근에 접근했던 메모리 공간에 다시 접근하려는 경향이 있다.
2. CPU는 접근한 메모리 공간 근처를 접근하려는 경향이 있다.

코드에서 사용했던 자주사용되는 변수들은 여러번 사용되는경향이 있다. 이를 **시간 지역성**이라고 한다.

또한 보통 CPU가 실행하려는 프로그램은 메모리의 한 곳에 모여있다. \ 
예를 들어 CPU가 워드 프로세서 프로그램을 실행할 때에는 해당 프로그램의 메모리 근처를 집중적으로 접근할 것이고, 사용자가 입력을 할 적에는 입력기능이 모여 공간 근처를 집중적으로 접근할 것이다. 이처럼 접근했던 메모리 공간 근처를 접근하는 경향을 **공간 지역성**이라고 한다.
